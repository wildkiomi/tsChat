var chatWidget,newMessage,minChat,maxChat,messageBox,submit,print,loginForm,text,addMessageToDb,messageStorage=[],initObj={},user={};ws=new WebSocket("ws://localhost:8080"),console.log("connect"),ws.onopen=function(e){console.log("connected to server")};var url="https://wildkiomichat.firebaseio.com",database=new Firebase(url);function ChatWidget({chatTitle:e,botName:t,chatUrl:s,cssName:a,position:n,requests:r,allowMinimize:i,allowDrag:o,requireName:c,showDateTime:d}){this.chatTitle=e||"Chat",this.botName=t||"Bot",this.chatUrl=s||"https://wildkiomichat.firebaseio.com",this.cssName=a||"primary",this.position=n||"right",this.requests=r||"fetch",this.allowMinimize=i||!1,this.allowDrag=o||!1,this.requireName=c||!1,this.showDateTime=d||!1,initObj=this,initializeChat(),addCss(),returnToPreviousState()}function initializeChat(e,t){switch((chatWidget=document.createElement("div")).classList.add("chatWidget","card"),chatWidget.innerHTML='<div id="headChat" class="chatHeader"><span id="titleOfChat" class="text-white">'+initObj.chatTitle+'</span></div><button id="minChat" class="turnButton btn btn-sm" value="_" type="submit"/></button><div id="maxChat" class="chatContent"><div id="print" class="printedMessages"></div><input id="messageBox" class="messageInput input-group-sm" type="text"/><button id="submitButton" type="button" class="submitButton btn btn-sm">Submit</button></div>',document.body.appendChild(chatWidget),minChat=document.getElementById("minChat"),maxChat=document.getElementById("maxChat"),messageBox=document.getElementById("messageBox"),submit=document.getElementById("submitButton"),print=document.getElementById("print"),initObj.allowMinimize&&minChat.addEventListener("click",turnChat),initObj.allowDrag&&dragChat(),initObj.requireName?createAuthMessage():(user=new User("anon"),submit.addEventListener("click",sendMessage)),initObj.cssName){case"danger":chatWidget.classList.add("bg-danger"),submit.classList.add("btn-danger"),minChat.classList.add("btn-danger");break;case"primary":chatWidget.classList.add("badge-primary"),submit.classList.add("btn-primary"),minChat.classList.add("btn-primary");break;case"success":chatWidget.classList.add("badge-success"),submit.classList.add("btn-success"),minChat.classList.add("btn-success");break;case"warning":chatWidget.classList.add("badge-warning"),submit.classList.add("btn-warning"),minChat.classList.add("btn-warning")}}function getCoords(e){var t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}}function dragChat(){(text=document.getElementById("titleOfChat")).onmousedown=function(e){var t=getCoords(text),s=e.pageX-t.left,a=e.pageY-t.top;function n(e){chatWidget.style.left=e.pageX-s+"px",chatWidget.style.top=e.pageY-a+"px"}document.body.appendChild(chatWidget),n(e),chatWidget.style.zIndex=1e3,document.onmousemove=function(e){n(e)},text.onmouseup=function(){document.onmousemove=null,text.onmouseup=null}},chatWidget.ondragstart=function(){return!1}}function addCss(){var e=document.createElement("link");e.rel="stylesheet",e.href="css/chatStyle.css",e.type="text/css",document.head.appendChild(e)}function returnToPreviousState(){maxChat.hidden=!!localStorage.getItem("hiddenChat"),chatWidget.style.height=localStorage.getItem("chatHeight");var e=JSON.parse(sessionStorage.getItem("historyMessage"));if(null!=sessionStorage.historyMessage)for(var t=0;t<e.length;t++){var s=document.createElement("div");"user"==e[t].writer?s.className="messageFromUser":s.className="messageFromBot",s.innerHTML=e[t].text,print.appendChild(s)}}function turnChat(){maxChat.hidden?(maxChat.hidden="",chatWidget.style.height="350px",localStorage.setItem("hiddenChat",""),localStorage.setItem("chatHeight","350px")):(maxChat.hidden=!0,chatWidget.style.height="30px",localStorage.setItem("hiddenChat","true"),localStorage.setItem("chatHeight","30px"))}function sendMessage(){newMessage=messageBox.value,messageBox.value="";var e=getRealTime();ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({time:e,writer:user.name,value:newMessage,toWho:"operator"})),printMessage(e,user.name,newMessage),addMessageToHistory(e,user.name,newMessage,"operator")}function printMessage(e,t,s){var a=document.createElement("div");a.classList.add("messageFromUser","badge-primary","badge","text-wrap"),initObj.showDateTime?a.innerHTML='<span class="badge badge-warning">'+e+'</span> <span class="badge badge-success">'+t+"</span> "+s:a.innerHTML='<span class="badge badge-success">'+t+"</span> "+s,print.appendChild(a)}function addMessageToHistory(e,t,s,a){null!=sessionStorage.getItem("historyMessage")&&(messageStorage=JSON.parse(sessionStorage.getItem("historyMessage"))),messageStorage.push({time:e,writer:t,value:s}),sessionStorage.setItem("historyMessage",JSON.stringify(messageStorage)),"xhr"==initObj.requests?addToDBviaXhr(e,t,s,a):addToDBviaFetch(e,t,s,a)}function getRealTime(){var e=new Date;return e.getHours()+":"+e.getMinutes()}function createAuthMessage(){var e=document.createElement("div");e.id="textDiv",e.classList.add("alert","alert-danger"),e.role="alert",e.innerHTML="<p>Please, enter your name to connect to operator</p>",print.appendChild(e);submit.addEventListener("click",getName)}function getName(){var e=messageBox.value;messageBox.value="",user=new User(e);var t=getRealTime();print.removeChild(textDiv),ws.send(JSON.stringify({time:t,writer:user.name,value:"new user",toWho:"operator"})),addToDBviaFetch(t,user.name,"new user","operator"),changeUserStatus("online"),submit.removeEventListener("click",getName),submit.addEventListener("click",sendMessage)}function User(e){this.name=e}function addToDBviaXhr(e,t,s,a){var n=new XMLHttpRequest;n.open("POST",url+"/users/"+user.name+"/history.json",!1),n.send(JSON.stringify({time:e,writer:t,value:s,toWho:a})),200!=n.status&&console.log(n.status+": "+n.statusText)}function addToDBviaFetch(e,t,s,a){fetch(url+"/users/"+user.name+"/history.json",{method:"post",body:JSON.stringify({time:e,writer:t,value:s,toWho:a})}).then(e=>e.json()).then(e=>console.log(e))}function changeUserStatus(e){var t=new XMLHttpRequest;t.open("POST",url+"/users/"+user.name+"/status.json",!1),t.send(JSON.stringify({status:e})),200!=t.status&&console.log(t.status+": "+t.statusText)}ws.onmessage=function(e){var t=JSON.parse(e.data);console.log("we got it"),addMessageToHistory(t.time,t.writer,t.value,t.toWho),printMessage(t.time,t.writer,t.value)},ws.onclose=function(e){changeUserStatus("offline"),console.log("connection closed")};var mongoose=require("mongoose");Schema=mongoose.Schema;var schema=new Schema({time:{type:String,require:!0},writer:{type:String,require:!0},value:{type:String,require:!0},toWho:{type:String,require:!0}});module.exports=mongoose.model("History",schema);var ws=new WebSocket("ws://localhost:8080"),order="";ws.onopen=function(e){console.log("connected to server"),ws.send(JSON.stringify({time:getRealTime(),writer:"operator",value:"connected"}))};url="https://wildkiomichat.firebaseio.com",database=new Firebase(url);var userSearch,currentUserName,userList=document.getElementById("usersList"),userHistory=document.getElementById("dialog"),divSearch=document.getElementById("divSearch"),messages=document.getElementById("message"),label1=document.getElementById("label1"),label2=document.getElementById("label2"),label3=document.getElementById("label3"),param1=document.getElementById("param1"),param2=document.getElementById("param2"),param3=document.getElementById("param3"),commandLog=document.getElementById("commandLog"),run=document.getElementById("run");function getRealTime(){var e=new Date;return e.getHours()+":"+e.getMinutes()}function downloadHistory(e){fetch(url+"/users/"+e+"/history.json").then(e=>e.json()).then(function(t){for(element in t)fetch(url+"/users/"+e+"/history/"+element+".json").then(e=>e.json()).then(function(e){printMessage(e.time,e.writer,e.value)})})}function sortUsers(){switch(document.forms.sortForm.elements.sort.value){case"a-j":order='?orderBy="$key"&startAt="a"&endAt="j"';break;case"k-q":order='?orderBy="$key"&startAt="k"&endAt="q"';break;case"r-z":order='?orderBy="$key"&startAt="r"&endAt="z"'}}function sendMessage(){newMessage=messages.value,messages.value="";var e=getRealTime();ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({time:e,writer:"operator",value:newMessage,toWho:currentUserName})),printMessage(e,"you",newMessage)}function printMessage(e,t,s){var a=document.createElement("div");a.innerHTML='<span class="badge badge-primary text-wrap"><span class="badge badge-warning">'+e+'</span> <span class="badge badge-success">'+t+"</span> "+s+"</span>",userHistory.appendChild(a)}function searchUser(){var e=document.getElementById("search").value;fetch(url+"/users.json").then(e=>e.json()).then(function(t){var s=!1;for(user in t)if(user==e){s=!0,(userSearch=document.createElement("div")).classList.add("userSearch"),userSearch.id=user,userSearch.innerHTML='<span class="badge badge-success">'+user+"</span> ",divSearch.appendChild(userSearch),userSearch.addEventListener("click",function(e){currentUserName=e.target.id.toString(),userHistory.innerHTML="",divSearch.removeChild(userSearch),downloadHistory(currentUserName)});break}0==s&&((userSearch=document.createElement("div")).classList.add("userSearch"),userSearch.innerHTML='<span class="badge badge-success">there is no such user</span> ',divSearch.appendChild(userSearch),userSearch.addEventListener("click",function(e){divSearch.removeChild(userSearch)}))})}function longPollingToDb(){var e=new XMLHttpRequest;e.onreadystatechange=function(){if(4==this.readyState&&200==this.status){if(this.responseText)for(user in users=JSON.parse(this.responseText),userList.innerHTML="",users){var e=document.createElement("div");e.classList.add("userDiv","bg-primary"),e.innerHTML='<span class="badge badge-pill badge-success">'+user,e.id=user,usersList.appendChild(e)}longPollingToDb()}},e.open("GET",url+"/users.json"+order,!0),e.send()}function getCommandInterface(){var e=document.forms.commandForm.elements.command.value;"getInfo"==e&&(label1.innerHTML="ipinfo",label2.innerHTML="ip-api",label3.innerHTML="geoip")}function runCommand(e,t){}function printCommand(e,t){var s=document.createElement("div");s.innerHTML='<span class="badge badge-warning">'+e+'</span><span class="badge badge-success">'+t[0]+" "+t[1]+" "+t[2]+" </span>",commandLog.appendChild(s)}function configureCommand(){var e=commandForm.elements.command.value,t=[];param1.checked&&t.push(label1.innerHTML),param2.checked&&t.push(label2.innerHTML),param3.checked&&t.push(label3.innerHTML),runCommand(e,t)}run.addEventListener("click",function(e){configureCommand(),runCommand(),printLog()}),usersList.addEventListener("click",function(e){currentUserName=e.target.id.toString(),userHistory.innerHTML="",downloadHistory(currentUserName)}),document.getElementById("submitButton").addEventListener("click",sendMessage),ws.onmessage=function(e){var t=JSON.parse(e.data);printMessage(t.time,t.writer,t.value)},longPollingToDb();var WebSocket=require("ws"),WebSocketServer=WebSocket.Server,wss=new WebSocketServer({port:8080}),clientSockets=new Map;function wsSend(e,t,s,a){if(null!=clientSockets.get(a)){var n=clientSockets.get(a);n.readyState===WebSocket.OPEN&&(n.send(JSON.stringify({time:e,writer:t,value:s,toWho:a})),console.log("sent"))}}wss.on("connection",function(e){console.log("connected new WebSocket");var t=!1;e.on("message",function(s){console.log("get message "+s),s=JSON.parse(s),t?wsSend(s.time,s.writer,s.value,s.toWho):(clientSockets.set(s.writer,e),t=!0)})});mongoose=require("mongoose");Schema=mongoose.Schema;var History=require("./history");schema=new Schema({name:{type:String,unique:!0,require:!0},id:{type:String,unique:!0,require:!0}});module.exports=mongoose.model("User",schema);