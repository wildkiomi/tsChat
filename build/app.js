var chatWidget,newMessage,minChat,maxChat,messageBox,submit,print,loginForm,text,user,ws,messageStorage=[],initObj={};function ChatWidget({chatTitle:e,botName:t,chatUrl:s,cssName:n,position:i,requests:o,allowMinimize:a,allowDrag:r,requireName:c,showDateTime:d}){this.chatTitle=e||"Chat",this.botName=t||"Bot",this.chatUrl=s||"https://wildkiomichat.firebaseapp.com/",this.cssName=n||"chat1",this.position=i||"right",this.requests=o||"fetch",this.allowMinimize=a||!1,this.allowDrag=r||!1,this.requireName=c||!1,this.showDateTime=d||!1,initObj=this,initializeChat(),addCss(),returnToPreviousState()}function initializeChat(e,t){(chatWidget=document.createElement("div")).className="chatWidget",chatWidget.innerHTML='<div id="minChat" class="chatHeader"><span id="titleOfChat">'+initObj.chatTitle+'</span><input id="turnChat" class="turnButton" value="_" type="submit"/></div><div id="maxChat" class="chatContent"><div id="print" class="printedMessages"></div><input id="messageBox" class="messageInput" type="text"/><button id="submitButton" type="button" class="submitButton">Submit</button></form></div>',document.body.appendChild(chatWidget),minChat=document.getElementById("minChat"),maxChat=document.getElementById("maxChat"),messageBox=document.getElementById("messageBox"),submit=document.getElementById("submitButton"),print=document.getElementById("print"),initObj.allowMinimize&&minChat.addEventListener("click",turnChat),submit.addEventListener("click",sendMessage),initObj.requireName?authUser():user=new User("anon",!1),initObj.allowDrag&&dragChat()}function getCoords(e){var t=e.getBoundingClientRect();return{top:t.top+pageYOffset,left:t.left+pageXOffset}}function dragChat(){(text=document.getElementById("titleOfChat")).onmousedown=function(e){var t=getCoords(text),s=e.pageX-t.left,n=e.pageY-t.top;function i(e){chatWidget.style.left=e.pageX-s+"px",chatWidget.style.top=e.pageY-n+"px"}document.body.appendChild(chatWidget),i(e),chatWidget.style.zIndex=1e3,document.onmousemove=function(e){i(e)},text.onmouseup=function(){document.onmousemove=null,text.onmouseup=null}},chatWidget.ondragstart=function(){return!1}}function addCss(){var e,t=document.createElement("style");switch(initObj.cssName){case"chat1":e="deeppink";case"chat2":e="green";case"chat3":e="yellow";case"chat4":e="orange"}t.innerHTML=".chatHeader{position: absolute;top: 0px;height: 30px;width: 250px;background-color: "+e+";}.chatContent{position: absolute;top: 30px;bottom: 0px;width: 250px;height: 320px;background-color: pink;}.chatTexts{text-align: justify;}.chatWidget{bottom: 10px;"+initObj.position+": 10px;position: absolute;width: 250px;height: 350px;border: solid 1px black;}.turnButton{position: absolute;right: 0px;width: 20px;}.printedMessages {position: absolute;top: 0px;bottom: 25px;height: 295px;width: 250px;overflow: scroll;}.messageFromUser{background-color: white;border-radius: 10px;padding: 2px;border: solid 1px black; }.messageFromBot{left: 10px;background-color: white;border-radius: 10px;padding: 2px;border: solid 1px black; }.messageInput {bottom: 0px;position: absolute;left: 0px;width: 140px;height: 20px;}.submitButton{ position: absolute; height: 28px;width: 110px;right: 0px;bottom: 0px;}",document.body.appendChild(t)}function returnToPreviousState(){maxChat.hidden=!!localStorage.getItem("hiddenChat"),chatWidget.style.height=localStorage.getItem("chatHeight");var e=JSON.parse(sessionStorage.getItem("historyMessage"));if(null!=sessionStorage.historyMessage)for(var t=0;t<e.length;t++){var s=document.createElement("div");"user"==e[t].writer?s.className="messageFromUser":s.className="messageFromBot",s.innerHTML=e[t].text,print.appendChild(s)}}function turnChat(){maxChat.hidden?(maxChat.hidden="",chatWidget.style.height="350px",localStorage.setItem("hiddenChat",""),localStorage.setItem("chatHeight","350px")):(maxChat.hidden=!0,chatWidget.style.height="30px",localStorage.setItem("hiddenChat","true"),localStorage.setItem("chatHeight","30px"))}function sendMessage(){newMessage=messageBox.value,messageBox.value="";var e=getRealTime();ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({time:e,writer:user.name,value:newMessage,toWho:"operator"})),printMessage(e,user.name,newMessage),addMessageToHistory(e,user.name,newMessage,"operator")}function printMessage(e,t,s){var n=document.createElement("div");n.className="messageFromUser",initObj.showDateTime?n.innerHTML=e+" "+t+": "+s:n.innerHTML=t+": "+s,print.appendChild(n)}function disconnect(){ws.close()}function addMessageToHistory(e,t,s,n){null!=sessionStorage.getItem("historyMessage")&&(messageStorage=JSON.parse(sessionStorage.getItem("historyMessage"))),messageStorage.push({time:e,writer:t,value:s}),sessionStorage.setItem("historyMessage",JSON.stringify(messageStorage)),"xhr"==initObj.requests?addToDBviaXhr(e,t,s,n):addToDBviaFetch(e,t,s,n)}function getRealTime(){var e=new Date;return e.getHours()+":"+e.getMinutes()}function authUser(){var e=prompt("enter your name");user=new User(e,!0)}function User(e,t){this.name=e,this.auth=t}(ws=new WebSocket("ws://localhost:8080")).onmessage=function(e){var t=JSON.parse(e.data);addMessageToHistory(t.time,t.writer,t.value,t.toWho),printMessage(t.time,t.writer,t.value)},(ws=new WebSocket("ws://localhost:8080")).onopen=function(e){console.log("connected to server")};var currentUserName,url="https://wildkiomichat.firebaseio.com",database=new Firebase(url),userList=document.getElementById("usersList"),userHistory=document.getElementById("dialog");downloadDb();var messages=document.getElementById("message");function getRealTime(){var e=new Date;return e.getHours()+":"+e.getMinutes()}function downloadDb(){fetch(url+"/users.json").then(e=>e.json()).then(function(e){for(user in e){var t=document.createElement("div");t.className="userDiv",t.innerHTML=user,t.id=user,usersList.appendChild(t)}})}function downloadHistory(e){fetch(url+"/users/"+e+"/history.json").then(e=>e.json()).then(function(t){for(element in t)fetch(url+"/users/"+e+"/history/"+element+".json").then(e=>e.json()).then(function(e){printMessage(e.time,e.writer,e.value)}).then(currentUserWs=message.toWho)})}function sendMessage(){newMessage=messages.value,messages.value="";var e=getRealTime();ws.readyState===WebSocket.OPEN&&ws.send(JSON.stringify({time:e,writer:"operator",value:newMessage,toWho:currentUserName})),printMessage(e,"you",newMessage)}function printMessage(e,t,s){var n=document.createElement("div");n.className="userDiv",n.innerHTML=e+" "+t+": "+s,userHistory.appendChild(n)}usersList.addEventListener("click",function(e){currentUserName=e.target.id.toString(),userHistory.innerHTML="",downloadHistory(currentUserName)}),document.getElementById("submitButton").addEventListener("click",sendMessage),ws.onmessage=function(e){var t=JSON.parse(e.data);printMessage(t.time,t.writer,t.value)};var WebSocket=require("ws"),WebSocketServer=WebSocket.Server,wss=new WebSocketServer({port:8080}),clientSockets=new Map;const MongoClient=require("mongodb").MongoClient,uuidv4=require("uuid/v4"),mongoClient=new MongoClient("mongodb://localhost:8080/",{useNewUrlParser:!0});function wsSend(e,t,s,n){if(null!=clientSockets.get(n)){var i=clientSockets.get(n);console.log(clientSockets.keys()),i.readyState===WebSocket.OPEN&&i.send(JSON.stringify({time:e,writer:t,value:s,toWho:n}))}}wss.on("connection",function(e){console.log("connected new WebSocket");var t=!1;e.on("message",function(s){console.log("get message "+s),s=JSON.parse(s),t||(clientSockets.set(s.writer,e),t=!0),wsSend(s.time,s.writer,s.value,s.toWho)})});